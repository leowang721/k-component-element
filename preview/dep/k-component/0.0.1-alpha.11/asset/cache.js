/*! @2015 Leo Wang. All Rights Reserved */
define("k-component/cache",["require","lodash","mini-event/EventTarget"],function(require){function add(e){var t=owners.push(e);return caches[t-1]={data:{}}}function innerData(e,t,n,r){var i=owners.indexOf(e),o=-1===i?add(e):caches[i],a="string"==typeof t,s=o;if(!r)o=o.data;if(t&&"object"==typeof t)_.extend(o,t);else if(a&&void 0!==n)o[t]=n;if(a){if(t in o)return o[t];else if(!r&&e&&1===e.nodeType)return cacheUtil.parseData(e,t,s)}else return o}function innerRemoveData(e,t,n){var r=owners.indexOf(e);if(r>-1){var i="string"==typeof t,o=caches[r],a=o;if(i){if(!n)o=o.data;if(o)i=o[t],delete o[t];if('{"data":{}}'===JSON.stringify(a))owners.splice(r,1),caches.splice(r,1)}return i}}function determineDiff(e,t,n){var r={};if(void 0!==n){var i=determineDiff(e,t);if(void 0!==i)r[n]=i;return r}else{if("object"==typeof t&&"object"==typeof e)return _.each(e,function(n,i){var o=determineDiff(e[i],t[i],i);if(void 0!==o)r[i]=o}),r;if(t!==e)return e}}var _=require("lodash"),owners=[],caches=[],rparse=/^(?:null|false|true|NaN|\{.*\}|\[.*\])$/,cacheUtil={hasData:function(e){return owners.indexOf(e)>-1},data:function(e,t,n){return innerData(e,t,n)},_data:function(e,t,n){return innerData(e,t,n,!0)},removeData:function(e,t){return innerRemoveData(e,t)},_removeData:function(e,t){return innerRemoveData(e,t,!0)},parseData:function(target,name,cache,value){var data,_eval,key=_.camelize(name);if(cache&&key in cache)return cache[key];if(4!==arguments.length){var attr="data-"+name.replace(/([A-Z])/g,"-$1").toLowerCase();value=target.getAttribute(attr)}if("string"==typeof value){if(rparse.test(value)||+value+""===value)_eval=!0;try{data=_eval?eval("0,"+value):value}catch(e){data=value}if(cache)cache[key]=data}return data},curry:function(e){var t={get:_.partial(cacheUtil.data,e),set:function(n,r){var i;if(n&&"object"==typeof n)i=determineDiff(n,t.get());else if("string"==typeof n&&void 0!==r)i=determineDiff(r,t.get(n),n);var o;if(_.keys(i).length>0)o={newValue:i,oldValue:_.clone(t.get())};if(cacheUtil.data(e,n,r),o)t.fire("change",o),_.each(o.newValue,function(e,n){t.fire("change:"+n,{newValue:e,oldValue:o.oldValue[n]})})},remove:function(n){var r=t.get(n);if(cacheUtil.removeData(e,n),void 0!==r)t.fire("change:"+n,{newValue:void 0,oldValue:r})},hasData:_.partial(cacheUtil.hasData,e)};return require("mini-event/EventTarget").enable(t),t}};return cacheUtil});