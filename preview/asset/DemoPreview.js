/*! @2015 Leo Wang. All Rights Reserved */
define("DemoPreview",["require","underscore","k-component/k","fc-core/Promise","fc-storage/localStorage","k-component/component!k-component-element/k-selection","k-component/component!k-component-element/k-list","k-component/component!k-component-element/mark-commandable","css!./demo-preview.css","./componentConfig","less","fc-core/oo","k-component/Action"],function(require){var e=require("underscore"),n=(require("k-component/k"),require("fc-core/Promise")),t=require("fc-storage/localStorage");require("k-component/component!k-component-element/k-selection"),require("k-component/component!k-component-element/k-list"),require("k-component/component!k-component-element/mark-commandable"),require("css!./demo-preview.css");var r=require("./componentConfig"),i={initialize:function(){this.type=this.el.attr("type")||"html",this.path=this.el.attr("path");var e=this.$("#demo-preview-coding-main")[0];this.editor=ace.edit(e),this.editor.setTheme("ace/theme/monokai"),this.editor.$blockScrolling=1/0,this.editor.setReadOnly(!0),this.adjustEditor()},initBehavior:function(){if(this.path)this.processPreivew()},bindEvents:function(){var e=this;e.$("#demo-preview-coding-main").on("keypress",function(n){if(13===n.keyCode&&n.ctrlKey)e.showPreview(),n.preventDefault()}),e.$("#demo-preview-coding-type").on("select",function(n){e.el.attr("type",e.$(n.target.selection.getSelected()).attr("data-value"))})},showPreview:function(){var n=this,t={};n.currentSaver&&n.currentSaver(),e.each(["html","less","javascript"],function(e){if(e===n.type)t[e]=n.editor.getValue();else t[e]=n.getCode(e)});var r=n.$("#demo-preview-result-main");r.html(t.html);var i=document.createElement("style"),o=require("less");o.render(t.less,function(e,n){if(e&&!n)alert("less parse error!!");i.innerHTML=n.css,r.append(i)});var a=document.getElementById("demo-preview-live-script");if(!a)a=document.createElement("script"),a.id="demo-preview-live-script",r.append(a);setTimeout(function(){a.innerHTML=t.javascript},1)},attributes:{path:function(e){this.path=e,this.processPreivew()},type:function(e){this.type=e,this.adjustEditor(),this.processPreivew()}},adjustEditor:function(){this.editor.getSession().setMode("ace/mode/"+this.type)},currentSaver:null,processPreivew:function(){var e=this,t=e.path;if(t)e.editor.setReadOnly(!0),n.require(["k-component/component!k-component-element/"+t]).then(function(){e.editor.setReadOnly(!1);var n=e.getCode();if(e.editor.setValue(n),e.currentSaver=e.getAutoSaver(),e.repeatMark)clearInterval(e.repeatMark);e.showPreview()})},getCode:function(e){var n=this;e=e||n.type;var i=n.path,o=t.getItem(i+"-"+e);if(!o)o=r[i][e];return o},getAutoSaver:function(){var e=this;return function(){t.setItem(e.path+"-"+e.type,e.editor.getValue())}},repeatMark:null,repeat:function(n){var t=this;t.repeatMark=setInterval(function(){n();var r=new Date,i=[r.getFullYear(),r.getMonth()+1,r.getDate()].join("-");i+=" "+[e.pad(r.getHours(),0,2),e.pad(r.getMinutes(),0,2),e.pad(r.getSeconds(),0,2)].join(":"),t.$("#demo-preview-autosave-info").html("自动保存于 "+i)},5e3)},dispose:function(){this.$super(arguments)}},o=require("fc-core/oo").derive(require("k-component/Action"),i);return o});